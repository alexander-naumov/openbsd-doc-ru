<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<!-- saved from url=(0042)http://www.openbsd.org/faq/pf/anchors.html -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>PF: Anchors</title>
<link rev="made" href="mailto:www@openbsd.org">

<meta name="resource-type" content="document">
<meta name="description" content="the OpenBSD FAQ page">
<meta name="keywords" content="openbsd,faq,pf">
<meta name="distribution" content="global">
</head>

<!--
Copyright (c) 2003-2007 Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<a href="http://www.openbsd.org/index.html">
<img alt="[OpenBSD]" height="30" width="141" src="./PF  Anchors_files/smalltitle.gif" border="0">
</a>
<p>
[<a href="http://www.openbsd.org/faq/pf/options.html">Предыдущая: Runtime Options</a>]
[<a href="http://www.openbsd.org/faq/pf/index.html">Содержание</a>]
[<a href="http://www.openbsd.org/faq/pf/queueing.html">Следующая: Управление очередями пакетов и приоритезация</a>]

</p><p>
</p><h1><font color="#e00000">PF: Якоря</font></h1>

<hr>

<h3>Содержание</h3>
<ul>
<li><a href="http://www.openbsd.org/faq/pf/anchors.html#intro">Введение</a>
</li><li><a href="http://www.openbsd.org/faq/pf/anchors.html#anchors">Якоря</a>
</li><li><a href="http://www.openbsd.org/faq/pf/anchors.html#options">Параметры якоря</a>
</li><li><a href="http://www.openbsd.org/faq/pf/anchors.html#manip">Управление якорями</a>
</li></ul>

<hr>

<a name="intro"></a>
<h2>Введение</h2>
В дополнение к основному набору правил, PF может также определять поднаборы
правил. Так как поднаборами можно манипулировать на лету с помощью
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&sektion=8&manpath=OpenBSD+5.1">pfctl(8)</a>,
то они предоставляют удобный способ динамического изменения активного набора
правил.
В то время как <a href="http://www.openbsd.org/faq/pf/tables.html">таблица</a>
используется для хранения динамического списка адресатов, поднабор используется
для хранения динамического набора правил.
Поднабор присоединяется к основному набору правил с использованием <tt>якоря</tt>.

<p>
Якоря могут быть вложенными, что позволяет поднаборы выстраивать в цепочку.
Правила якорей могут быть определены относительно якорей в которые они
загружены.
Например, правила, объявляющие якоря, в основном наборе правил могут создать
точки присоединения якоря к основному набору как к его родителю, и набор правил
загруженный из файла с помощью директивы <tt>load anchor</tt> может создать
точку присоединения якоря для которого он будет родителем.

<a name="named"></a>
<a name="anchors"></a>
</p><h2>Якоря</h2>
Якорь - это набор правил, таблиц и других якорей, которым присвоено имя.
Когда PF находит правило якоря в основном наборе правил, он подставляет правила,
определенные в нем так, как будто они были определены в основном наборе.
Далее обработка продолжается в основном наборе правил, если только пакет не
подпадает под фильтр, который содержит параметр <tt>quick</tt>.
В этом случае совпадение будет считаться окончательным и разбор правил будет
прерван в обоих наборах правил - в якоре и в основном наборе.

<p>
Например:
</p><blockquote>
<tt>
ext_if = "fxp0"<br>
<br>
block on $ext_if<br>
pass &nbsp;out on $ext_if<br>
anchor goodguys
</tt>
</blockquote>

<p>
Этот набор устанавливает на умолчанию политику запрета на интерфейсе <tt>fxp0</tt>
как для входящего, так и исходящего трафика.
Далее трафик будет выпущен с интерфейса и загружен набор правил с именем
<tt>goodguys</tt>.
Якоря могут быть наполнены правилами тремя способами:
</p><ul>
<li>с помощью правила <tt>load</tt>
</li><li>с помощью 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&sektion=8&manpath=OpenBSD+5.1">pfctl(8)</a>
</li><li>с помощью определения правил непосредственно (inline) в основном наборе
правил
</li></ul>

<p>
Правило <tt>load</tt> указывает <tt>pfctl</tt> наполнить указанный якорь
прочитав правила из текстового файла.
Правило <tt>load</tt> должно быть расположено после правила <tt>anchor</tt>.
Например:
</p><blockquote>
<tt>
anchor goodguys<br>
load anchor goodguys from "/etc/anchor-goodguys-ssh"
</tt>
</blockquote>

<p>
Для добавления правил к якорю с помощью <tt>pfctl</tt>, может быть использована
команда следующего вида:
</p><blockquote>
<tt>
# echo "pass in proto tcp from 192.0.2.3 to any port 22" \<br>
&nbsp;&nbsp;&nbsp;| pfctl -a goodguys -f -
</tt>
</blockquote>

<p>
Правила также могут быть сохранены и загружены из текстового файла:
</p><blockquote>
<tt>
# cat &gt;&gt; /etc/anchor-goodguys-www<br>
pass in proto tcp from 192.0.2.3 to any port 80<br>
pass in proto tcp from 192.0.2.4 to any port { 80 443 }<br>
<br>
# pfctl -a goodguys -f /etc/anchor-goodguys-www<br>
</tt>
</blockquote>

<p>
To load rules directly from the main ruleset, enclose the anchor rules
in a brace-delimited block:

</p><blockquote>
<tt>
anchor "goodguys" { <br>
&nbsp;&nbsp;&nbsp;pass in proto tcp from 192.168.2.3 to port 22<br>
}
</tt>
</blockquote>

<p>
Inline anchors can also contain more anchors.

</p><blockquote>
<tt>
allow = "{ 192.0.2.3 192.0.2.4 }" <br>
<br>
anchor "goodguys" { <br>
&nbsp;&nbsp;&nbsp;anchor { <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pass in proto tcp from 192.0.2.3 to port 80 <br>
&nbsp;&nbsp;&nbsp;} <br>
&nbsp;&nbsp;&nbsp;pass in proto tcp from $allow to port 22<br>
}
</tt>
</blockquote>

With inline anchors the name of the anchor becomes optional.
Note how the nested anchor in the above example does not have a name.
Also note how the macro <tt>$allow</tt> is created outside of the anchor
(in the main ruleset) and is then used within the anchor.

<p>
Rules can be loaded into an anchor using the same syntax and options
as rules loaded into the main ruleset.
One caveat, however, is that unless you're using inline anchors any 
<a href="http://www.openbsd.org/faq/pf/macros.html">macros</a> that are used must also be defined 
within the anchor itself; macros that are defined in the parent ruleset
are <i>not</i> visible from the anchor.

</p><p>
Since anchors can be nested, it's possible to specify that all child
anchors within a specified anchor be evaluated:

</p><blockquote>
<tt>
anchor "spam/*"
</tt>
</blockquote>

<p>
This syntax causes each rule within each anchor attached to the
<tt>spam</tt> anchor to be evaluated.
The child anchors will be evaluated in alphabetical order but are not
descended into recursively. 
Anchors are always evaluated relative to the anchor in which they're
defined.

</p><p>
Each anchor, as well as the main ruleset, exist separately from
the other rulesets. Operations done on one ruleset, such as flushing the
rules, do not affect any of the others.  In addition, removing an anchor
point from the main ruleset does not destroy the anchor or any child
anchors that are attached to that anchor. An anchor is not
destroyed until it's flushed of all rules using
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&sektion=8&manpath=OpenBSD+5.1">pfctl(8)</a> and there are no child anchors within the anchor. 

<a name="options"></a>
</p><h2>Anchor Options</h2>
Optionally, <tt>anchor</tt> rules can specify interface, protocol,
source and destination address, tag, etc., using the same syntax as other
rules. When such information is given, <tt>anchor</tt> rules are only
processed if the packet matches the <tt>anchor</tt> rule's definition.
For example:
<blockquote>
<tt>
ext_if = "fxp0"<br>
<br>
block on $ext_if<br>
pass &nbsp;out on $ext_if<br>
anchor ssh in on $ext_if proto tcp to port 22<br>
</tt>
</blockquote>

<p>
The rules in the anchor <tt>ssh</tt> are only evaluated for TCP
packets destined for port 22 that come in on <tt>fxp0</tt>.
Rules are then added to the <tt>anchor</tt> like so:
</p><blockquote>
<tt>
# echo "pass in from 192.0.2.10 to any" | pfctl -a ssh -f -
</tt>
</blockquote>

<p>
So, even though the filter rule doesn't specify an interface, protocol,
or port, the host 192.0.2.10 will only be permitted to connect using 
SSH because of the <tt>anchor</tt> rule's definition.

</p><p>
The same syntax can be applied to inline anchors.

</p><blockquote>
<tt>
allow = "{ 192.0.2.3 192.0.2.4 }" <br>
<br>
anchor "goodguys" in proto tcp { <br>
&nbsp;&nbsp;&nbsp;anchor proto tcp to port 80 { <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pass from 192.0.2.3 <br>
&nbsp;&nbsp;&nbsp;} <br>
&nbsp;&nbsp;&nbsp;anchor proto tcp to port 22 { <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pass from $allow<br>
&nbsp;&nbsp;&nbsp;} <br>
}
</tt>
</blockquote>


<a name="manip"></a>
<h2>Manipulating Anchors</h2>
Manipulation of anchors is performed via <tt>pfctl</tt>. It can
be used to add and remove rules from an anchor without reloading the
main ruleset.

<p>
To list all the rules in the anchor named <tt>ssh</tt>:
</p><blockquote>
<tt>
# pfctl -a ssh -s rules
</tt>
</blockquote>

<p>
To flush all rules from the same anchor:
</p><blockquote>
<tt>
# pfctl -a ssh -F rules
</tt>
</blockquote>

<p>
For a full list of commands, please see
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&sektion=8&manpath=OpenBSD+5.1">pfctl(8)</a>.

</p><p>
[<a href="http://www.openbsd.org/faq/pf/options.html">Предыдущая: Runtime Options</a>]
[<a href="http://www.openbsd.org/faq/pf/index.html">Содержание</a>]
[<a href="http://www.openbsd.org/faq/pf/queueing.html">Следующая: Управление очередями пакетов и приоритезация</a>]

</p><p>
</p><hr>
<a href="http://www.openbsd.org/faq/pf/index.html"><img height="24" width="24" src="./PF  Anchors_files/back.gif" border="0" alt="[back]"></a> 
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>$OpenBSD: anchors.html,v 1.32 2012/05/11 11:20:04 nick Exp $</small>


 
</body><link rel="stylesheet" type="text/css" href="data:text/css,"></html>